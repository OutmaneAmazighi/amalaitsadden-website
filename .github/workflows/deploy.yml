name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main  # Set a branch name to trigger deployment

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: |
          # Create 404.html for SPA routing
          mkdir -p static-assets
          cat > static-assets/404.html << 'EOL'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Association Amal Ait Sadden</title>
            <script>
              // Capture the path and query params from the current URL
              const path = window.location.pathname.slice(1);
              const query = window.location.search.slice(1);
              
              // Redirect to the index.html with these params
              window.location.href = 
                window.location.origin + 
                window.location.pathname.split('/').slice(0, -1).join('/') + 
                '/' +
                '?' + 
                (path ? 'p=' + path + '&' : '') + 
                query;
            </script>
          </head>
          <body>
            <p>Redirecting to homepage...</p>
          </body>
          </html>
          EOL
          
          # Build the project with GitHub Pages config
          npm run build -- --config vite.config.gh.js
          
          # Copy 404.html to build directory
          cp static-assets/404.html build/404.html
          
          # Add SPA routing handler to index.html
          sed -i 's/<head>/<head>\n  <script>\n    \/\/ Handle GitHub Pages routing\n    (function() {\n      const query = window.location.search.substring(1);\n      const pairs = query.split(\'&\').map(pair => pair.split(\'=\'));\n      const params = pairs.reduce((acc, pair) => {\n        acc[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || \'\');\n        return acc;\n      }, {});\n      \n      if (params.p) {\n        history.replaceState(null, null, params.p + (query.replace(\'p=\' + params.p, \'\') ? \'?\' + query.replace(\'p=\' + params.p + \'&\', \'\').replace(\'p=\' + params.p, \'\') : \'\'));\n      }\n    })();\n  <\/script>/' build/index.html

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages  # The branch the action should deploy to.
          folder: build  # The folder the action should deploy.
          clean: true  # Automatically remove deleted files from the deploy branch